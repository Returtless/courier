# üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ handlers/

–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Telegram –±–æ—Ç–∞.

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
handlers/
‚îú‚îÄ‚îÄ __init__.py              # CourierBot - –≥–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ base_handlers.py         # ‚úÖ –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –º–µ–Ω—é
‚îú‚îÄ‚îÄ traffic_handlers.py      # ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–±–æ–∫
‚îú‚îÄ‚îÄ call_handlers.py         # ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–≤–æ–Ω–∫–æ–≤
‚îú‚îÄ‚îÄ import_handlers.py       # ‚úÖ –ò–º–ø–æ—Ä—Ç –∏–∑ –®–µ—Ñ–ú–∞—Ä–∫–µ—Ç
‚îú‚îÄ‚îÄ settings_handlers.py     # ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îú‚îÄ‚îÄ route_handlers.py        # ‚ö†Ô∏è –ó–∞–≥–ª—É—à–∫–∏ (–∫–æ–¥ –≤ ../handlers.py)
‚îú‚îÄ‚îÄ order_handlers.py        # ‚ö†Ô∏è –ó–∞–≥–ª—É—à–∫–∏ (–∫–æ–¥ –≤ ../handlers.py)
‚îî‚îÄ‚îÄ legacy_bridge.py         # üîß –ú–æ—Å—Ç –∫ —Å—Ç–∞—Ä–æ–º—É –∫–æ–¥—É
```

---

## üéØ –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

### ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ (—Ä–∞–±–æ—Ç–∞—é—Ç):

1. **base_handlers.py**
   - `/start`, `/help`
   - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
   - –†–æ—É—Ç–∏–Ω–≥ callback –∑–∞–ø—Ä–æ—Å–æ–≤

2. **traffic_handlers.py**
   - –ó–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
   - –°—Ç–∞—Ç—É—Å –ø—Ä–æ–±–æ–∫

3. **call_handlers.py**
   - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤
   - –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∑–≤–æ–Ω–∫–∞–º

4. **import_handlers.py**
   - `/set_credentials`, `/delete_credentials`
   - `/import_orders`
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

5. **settings_handlers.py**
   - –ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
   - –°–±—Ä–æ—Å –∫ —É–º–æ–ª—á–∞–Ω–∏—é
   - –ú–µ–Ω—é —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –®–µ—Ñ–ú–∞—Ä–∫–µ—Ç

### ‚ö†Ô∏è –ú–æ–¥—É–ª–∏ —Å –∑–∞–≥–ª—É—à–∫–∞–º–∏ (–∫–æ–¥ –≤ —Å—Ç–∞—Ä–æ–º handlers.py):

6. **route_handlers.py**
   - –¢–æ—á–∫–∞ —Å—Ç–∞—Ä—Ç–∞
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
   - –ü–æ–∫–∞–∑ –º–∞—Ä—à—Ä—É—Ç–∞
   - –ì—Ä–∞—Ñ–∏–∫ –∑–≤–æ–Ω–∫–æ–≤
   - –°–±—Ä–æ—Å –¥–Ω—è

7. **order_handlers.py**
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
   - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
   - –î–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
   - –ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É

---

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```python
# –í __init__.py:
class CourierBot:
    def __init__(self, bot, llm_service):
        # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
        self.db_service = DatabaseService()
        self.maps_service = MapsService()
        # ...
        
        # 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π
        self.base = BaseHandlers(self)
        self.orders = OrderHandlers(self)
        self.routes = RouteHandlers(self)
        self.calls = CallHandlers(self)
        self.settings = SettingsHandlers(self)
        self.imports = ImportHandlers(self)
        self.traffic = TrafficHandlers(self)
    
    def register_handlers(self):
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        self.base.register()
        self.orders.register()
        # ...
```

### –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º

–ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º —á–µ—Ä–µ–∑ `self.parent`:

```python
class SomeHandlers:
    def __init__(self, bot_instance):
        self.bot = bot_instance.bot      # Telegram bot
        self.parent = bot_instance        # CourierBot instance
    
    def some_method(self):
        # –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º:
        orders = self.parent.db_service.get_today_orders(user_id)
        coords = self.parent.maps_service.geocode(address)
        settings = self.parent.settings_service.get_settings(user_id)
```

---

## üìù –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–∞

–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –Ω—É–∂–Ω–æ:

### 1. –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ route_handlers.py

–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã –∏–∑ `../handlers.py`:
- `handle_set_start_location()` (—Å—Ç—Ä–æ–∫–∞ ~1150)
- `handle_optimize_route()` (—Å—Ç—Ä–æ–∫–∞ ~1370)
- `handle_show_route()` (—Å—Ç—Ä–æ–∫–∞ ~2000)
- `handle_show_calls()` (—Å—Ç—Ä–æ–∫–∞ ~2100)
- `handle_reset_day()` (—Å—Ç—Ä–æ–∫–∞ ~1075)
- `process_start_location*()` –º–µ—Ç–æ–¥—ã
- `_update_route_point()`

### 2. –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ order_handlers.py

–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã –∏–∑ `../handlers.py`:
- `handle_add_orders()` (—Å—Ç—Ä–æ–∫–∞ ~850)
- `handle_order_details_start()` (—Å—Ç—Ä–æ–∫–∞ ~2292)
- `show_order_details()` (—Å—Ç—Ä–æ–∫–∞ ~1714)
- `mark_order_delivered()` (—Å—Ç—Ä–æ–∫–∞ ~2430)
- –í—Å–µ `process_order_*()` –º–µ—Ç–æ–¥—ã
- `_update_order_field()`

### 3. –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–º–µ–Ω—ã

–ü—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –∑–∞–º–µ–Ω–∏—Ç—å:
```python
self.db_service        ‚Üí  self.parent.db_service
self.maps_service      ‚Üí  self.parent.maps_service
self.traffic_monitor   ‚Üí  self.parent.traffic_monitor
self.settings_service  ‚Üí  self.parent.settings_service
self.call_notifier     ‚Üí  self.parent.call_notifier
self.user_states       ‚Üí  self.parent.user_states (–∏–ª–∏ –º–µ—Ç–æ–¥—ã get/update/clear)
self._main_menu_markup ‚Üí  self.parent._main_menu_markup
```

**–ù–ï –∑–∞–º–µ–Ω—è—Ç—å:**
- `self.bot` - –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
- `self.parent` - –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å

---

## üé® –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

‚úÖ **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å** - 200-400 —Å—Ç—Ä–æ–∫ –Ω–∞ –º–æ–¥—É–ª—å –≤–º–µ—Å—Ç–æ 4174  
‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –º–æ–¥—É–ª–µ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ  
‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥—É–ª–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏  
‚úÖ **–ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞** - –º–∏–Ω–∏–º—É–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏  

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **`REFACTORING_STATUS.md`** - –ø–æ–¥—Ä–æ–±–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–Ω–æ—Å–∞
- **`REFACTORING_PLAN.md`** - –Ω–∞—á–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω
- **`NEXT_STEPS.md`** - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
python -m src.bot.main
```

–ë–æ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π. –§—É–Ω–∫—Ü–∏–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞–∂—É—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–µ—Ä–µ–Ω–æ—Å–µ.

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
- ‚úÖ `/start` - –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- ‚úÖ `/import_orders` - –¥–æ–ª–∂–µ–Ω –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ - –¥–æ–ª–∂–Ω—ã –æ—Ç–∫—Ä—ã—Ç—å—Å—è –∏ —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ –ó–≤–æ–Ω–∫–∏ - callback –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚ö†Ô∏è –ú–∞—Ä—à—Ä—É—Ç—ã - –ø–æ–∫–∞–∂—É—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–Ω–æ—Å–µ
- ‚ö†Ô∏è –ó–∞–∫–∞–∑—ã - –ø–æ–∫–∞–∂—É—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–Ω–æ—Å–µ

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞
2. –°–º–æ—Ç—Ä–∏—Ç–µ `REFACTORING_STATUS.md`
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `legacy_bridge.py` –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

---

**–°–æ–∑–¥–∞–Ω–æ:** 15 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** 78% –≥–æ—Ç–æ–≤–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ 100% –≥–æ—Ç–æ–≤–∞

